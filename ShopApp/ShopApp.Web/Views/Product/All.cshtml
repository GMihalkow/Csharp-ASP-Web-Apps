@model IEnumerable<CategoryViewModel>

<section class="products-wrapper">
    <section class="products-wrapper-admin-toolbar">
        @if (this.User.Identity.IsAuthenticated)
        {
            if (this.User.IsInRole("Administrator"))
            {
                <button id="create-category" class="ui-button ui-widget ui-corner-all" type="button">Create</button>
            }
        }
    </section>
    <section class="product-categories">
        <header>Category</header>
        <section class="categories-list">
            <ul>
                @foreach (var category in this.Model)
                {
                    <li>@Html.Partial("_CategoryPartial", category)</li>
                }
            </ul>
        </section>
    </section>
    <section class="product-items">
        <header>Featured Items</header>
        <section class="featured-products"></section>
    </section>
</section>

<div id="confirm-order" title="Confirm Order">
    <p>Are you sure that u want to continue?</p>
</div>

<div id="product-details-dialog" title="Product Details">

</div>

@if (this.User.Identity.IsAuthenticated)
{
    if (this.User.IsInRole("Administrator"))
    {
        <div id="create-category-form-wrapper" title="Create Category">
            @Html.Partial("_CreateCategoryFormPartial", new CategoryViewModel())
        </div>

        <div id="add-product-form-wrapper" title="Add a Product">
            @Html.Partial("_AddProductFormPartial", new ProductInputModel())
        </div>
    }
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script id="product-details-template" type="text/html">
        @Html.Partial("_ProductDetailsPartialTemplate")
    </script>

    <script id="product-container-template" type="text/html">
        @Html.Partial("_ProductPartialTemplate")
    </script>

    <script type="text/javascript">
        $(function () {
            // add product form
            var addProductFormDialog = $("#add-product-form-wrapper");

            addProductFormDialog.dialog({
                autoOpen: false,
                height: 650,
                width: 500,
                modal: true,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "explode",
                    duration: 500
                },
                buttons: {
                    Create: function () {
                        var $form = $("#add-product-form-wrapper .modal-form");
                        $form.submit();
                    },
                    Cancel: function () {
                        addProductFormDialog.dialog("close");
                    }
                },
                close: function () {
                    //form[0].reset();
                    //allFields.removeClass("ui-state-error");
                }
            });

            $("[shop-action='add-product']").button().on("click", function () {
                // TODO [GM]: Resolve this problem
                // emptying form input fields
                //addProductFormDialog.find("input, textarea").val("");

                var categoryId = $(this).parent().children("a[shop-role-id]");

                var $categoryIdInput = $("#add-product-form-wrapper #CategoryId");

                $categoryIdInput.attr("value", $(categoryId).attr("shop-role-id"));

                // showing the form
                addProductFormDialog.dialog("open");
            });

            // product details popup dialog
            var productDetailsDialog = $("#product-details-dialog");

            productDetailsDialog.dialog({
                autoOpen: false,
                height: 600,
                width: 500,
                modal: true,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "explode",
                    duration: 500
                },
                buttons: {
                    Cancel: function () {
                        productDetailsDialog.dialog("close");
                    }
                }
            });

            // confirm order popup
            var confirmOrderDialog = $("#confirm-order");

            confirmOrderDialog.dialog({
                autoOpen: false,
                height: 200,
                width: 400,
                modal: true,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "explode",
                    duration: 500
                },
                buttons: {
                    Confirm: function () {
                        // TODO [GM]: get the quantity with closest() or find()
                        var productQuantity = $(this).attr("shop-product-quantity");
                        var productId = $(this).attr("shop-product-id");

                        if (productQuantity > 0) {
                            window.sessionStorage.setItem(productId, productQuantity);
                        }

                        $(".banner-order-information i").text(window.sessionStorage.length);

                        confirmOrderDialog.dialog("close");
                    },
                    Cancel: function () {
                        confirmOrderDialog.dialog("close");
                    }
                }
            });

            // create category form
            var createCategoryFormDialog = $("#create-category-form-wrapper");

            createCategoryFormDialog.dialog({
                autoOpen: false,
                height: 250,
                width: 350,
                modal: true,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "explode",
                    duration: 500
                },
                buttons: {
                    Create: function () {
                        var $form = $("#create-category-form-wrapper .modal-form");
                        $form.submit()
                    },
                    Cancel: function () {
                        createCategoryFormDialog.dialog("close");
                    }
                },
                close: function () {
                    //form[0].reset();
                    //allFields.removeClass("ui-state-error");
                }
            });

            $("#create-category").button().on("click", function () {
                createCategoryFormDialog.dialog("open");
            });

            // fetching the products per category
            // TODO [GM]: Implement fully
            $(".category-partial > a").on("click", function (e) {
                var categoryId = $(e.currentTarget).attr("shop-role-id");

                $.ajax({
                    url: "/Category/GetCategoryProducts/" + categoryId,
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then(function (res) {
                    var productsHolderElement = $(".products-wrapper > .product-items > section");
                    productsHolderElement.html("");

                    Array.from(res).forEach(function (product) {
                        var template = $("#product-container-template").html();
                        var rendered = Mustache.render(template, product);

                        // fade in animation
                        productsHolderElement.append(rendered).hide().fadeIn("slow");
                    });

                    var orderButtons = $("[shop-action='order-product']");
                    orderButtons.on("click", function () {

                        // show error when not
                        @if (!this.User.Identity.IsAuthenticated)
                        {
                            @: var errorDialog = $("#error-dialog");
                            @: var template = $("#error-partial-template").html();
                            @: var rendered = Mustache.render(template, { Message: "TEST MESSAGE" });

                            @: $("#error-dialog").html(rendered);

                            @: errorDialog.dialog("open");
                        }
                        else
                        {
                            @:var productQuantity = $(this).parent().parent().find("[shop-product-quantity]");
                            @:var productId = $(this).closest("[shop-product-id]").attr("shop-product-id");

                            @:confirmOrderDialog.attr("shop-product-id", productId);
                            @:confirmOrderDialog.attr("shop-product-quantity", productQuantity.val() > 0 ? productQuantity.val() : 0);

                            @:confirmOrderDialog.dialog("open");

                            // emptying the quantity input
                            @:productQuantity.val("");
                        }

                    });

                    var productDetailsButtons = $("[shop-action='product-details']");
                    productDetailsButtons.on("click", function () {
                        var productId = $(this).closest("[shop-product-id]").attr("shop-product-id");

                        $.ajax({
                            method: "POST",
                            url: "/Product/GetProduct/" + productId
                        }).then(function (product) {
                            var template = $("#product-details-template").html();
                            var rendered = Mustache.render(template, product);

                            $("#product-details-dialog").html(rendered);

                            productDetailsDialog.dialog("open");
                        });
                    });
                });
            });

            var $form = $(".modal-form");
            $.validator.unobtrusive.parse($form);
        });
    </script>
}