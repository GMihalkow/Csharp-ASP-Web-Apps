@model IEnumerable<CategoryViewModel>

<section class="products-wrapper">
    <section class="products-wrapper-admin-toolbar">
        @if (this.User.Identity.IsAuthenticated)
        {
            if (this.User.IsInRole(RolesConstants.Administrator))
            {
                <button id="create-category" class="ui-button ui-widget ui-corner-all" type="button">Create</button>
            }
        }
    </section>
    <section class="product-categories">
        <header>Category</header>
        <section class="categories-list">
            <ul>
                @foreach (var category in this.Model)
                {
                    <li>@Html.Partial("_CategoryPartial", category)</li>
                }
            </ul>
        </section>
    </section>
    <section class="product-items">
        <header>Featured Items</header>
        <section class="featured-products"></section>
    </section>
</section>

<div id="confirm-order" title="Confirm Order">
    <p>Are you sure that u want to continue?</p>
</div>

<div id="product-details-dialog" title="Product Details">

</div>

@if (this.User.Identity.IsAuthenticated)
{
    if (this.User.IsInRole(RolesConstants.Administrator))
    {
        <div id="create-category-form-wrapper" title="Create Category"></div>

        <div id="add-product-form-wrapper" title="Add a Product"></div>
    }
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")

    <script id="product-details-template" type="text/html">
        @Html.Partial("_ProductDetailsPartialTemplate")
    </script>

    <script id="add-product-form-template">
        @Html.Partial("_AddProductFormPartial", new ProductInputModel())
    </script>

    <script id="product-container-template" type="text/html">
        @Html.Partial("_ProductPartialTemplate")
    </script>

    <script id="create-category-form-template" type="text/html">
        @Html.Partial("_CreateCategoryFormPartial", new CategoryInputModel())
    </script>

    <script type="text/javascript">
        $(function () {
            // attaching remove category functionality
            var removeCategoryButtons = $("[shop-action='delete-category']");
            removeCategoryButtons.on("click", function (e) {
                var _this = $(this);

                // TODO [GM]: Maybe change [shop-role-id] to [shop-category-id] ?
                var categoryId = $(e.currentTarget).parent().find("[shop-role-id]").attr("shop-role-id");

                $.ajax({
                    url: "/Category/Delete/" + categoryId
                }).then(function (res) {
                    // removing the category from the categories list
                    _this.parent().remove();

                    // reloading the page
                    window.location.reload();
                });
            });

            // add product form
            var addProductFormDialog = $("#add-product-form-wrapper");

            addProductFormDialog.dialog({
                autoOpen: false,
                height: 650,
                width: 500,
                modal: true,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "explode",
                    duration: 500
                },
                buttons: {
                    Create: function () {
                        var $form = $("#add-product-form-wrapper .modal-form");
                        $form.submit();
                    },
                    Cancel: function () {
                        @* Reseting the form values *@
                        var $addProductForm = $("#add-product-form-wrapper > form");
                        $addProductForm[0].reset();

                        addProductFormDialog.dialog("close");
                    }
                },
                close: function () {
                    @* Reseting the form values *@
                    var $addProductForm = $("#add-product-form-wrapper > form");
                    $addProductForm[0].reset();
                }
            });

            $("[shop-action='add-product']").button().on("click", function () {
                var template = $("#add-product-form-template").html();
                $("#add-product-form-wrapper").html(template);

                var categoryId = $(this).parent().children("a[shop-role-id]");

                var $categoryIdInput = $("#add-product-form-wrapper #CategoryId");

                $categoryIdInput.attr("value", $(categoryId).attr("shop-role-id"));

                // showing the form
                addProductFormDialog.dialog("open");
            });

            // product details popup dialog
            var productDetailsDialog = $("#product-details-dialog");

            productDetailsDialog.dialog({
                autoOpen: false,
                height: 620,
                width: 500,
                modal: true,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "explode",
                    duration: 500
                },
                buttons: {
                    @if (this.User.Identity.IsAuthenticated && this.User.IsInRole(RolesConstants.Administrator))
                    {
                        @: Edit: function () {
                        @:  var template = $("#add-product-form-template").html();
                        @:  var $addProductForm = $("#add-product-form-wrapper").html(template);

                        @:  var productId = $(this).parent().find("[shop-product-id]").attr("shop-product-id");
                        @:  var productName = $(this).parent().find("[shop-product-name]").text();
                        @:  var productPrice = $(this).parent().find("[shop-product-price]").text();
                        @:  var productCoverURL = $(this).parent().find("[shop-product-cover-url]").attr("src");
                        @:  var productDescription = $(this).parent().find("[shop-product-description]").text().trim();

                        @*  TODO [GM]: Implement edit product functionalit fully and find a way to pass the category id *@
                        @*  changing the title of the dialog and the button's name *@
                        @:  $addProductForm.prev().find(".ui-dialog-title").text("Edit Product");
                        @:  $addProductForm.next().find("button").first().text("Edit")

                        @:  $addProductForm.find("#Name").attr("value", productName);
                        @:  $addProductForm.find("#Description").text(productDescription);
                        @:  $addProductForm.find("#Price").attr("value", productPrice);
                        @:  $addProductForm.find("#CoverUrl").attr("value", productCoverURL);
                        @:  $addProductForm.append("<input id='Id' name='Id' type='hidden' value='" + productId + "' />");

                        @:  addProductFormDialog.dialog("open");
                        @:  

                        @: 
                        @: },
                    }
                    Cancel: function () {
                        productDetailsDialog.dialog("close");
                    },
                }
            });

            // confirm order popup
            var confirmOrderDialog = $("#confirm-order");

            confirmOrderDialog.dialog({
                autoOpen: false,
                height: 200,
                width: 400,
                modal: true,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "explode",
                    duration: 500
                },
                buttons: {
                    Confirm: function () {
                        var productQuantity = $(this).attr("shop-product-quantity");
                        var productId = $(this).attr("shop-product-id");
                        var productName = $(this).attr("shop-product-name");

                        if (productQuantity > 0) {
                            window.sessionStorage.setItem(productName, JSON.stringify({ quantity: productQuantity, productId: productId }));
                        }

                        $(".banner-order-information i").text(window.sessionStorage.length);

                        confirmOrderDialog.dialog("close");
                    },
                    Cancel: function () {
                        confirmOrderDialog.dialog("close");
                    }
                }
            });

            // create category form
            var createCategoryFormDialog = $("#create-category-form-wrapper");

            createCategoryFormDialog.dialog({
                autoOpen: false,
                height: 400,
                width: 350,
                modal: true,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "explode",
                    duration: 500
                },
                buttons: {
                    Create: function () {
                        var $form = $("#create-category-form-wrapper .modal-form");
                        $form.submit()
                    },
                    Cancel: function () {
                        @* reseting the add category form *@
                        var $addCategoryForm = $("#create-category-form-wrapper > form");
                        $addCategoryForm[0].reset();

                        createCategoryFormDialog.dialog("close");
                    }
                },
                close: function () {
                    @* reseting the add category form *@
                    var $addCategoryForm = $("#create-category-form-wrapper > form");
                    $addCategoryForm[0].reset();
                }
            });

            $("#create-category, [shop-action='edit-category']").button().on("click", function (e) {
                var template = $("#create-category-form-template").html();
                console.log(template);
                createCategoryFormDialog.html(template);

                if ($(e.currentTarget).attr("shop-action") === "edit-category") {
                    var categoryId = $(this).parent().find("[shop-role-id]").attr("shop-role-id");

                    $.ajax({
                        url: "/Category/Get/" + categoryId,
                        method: "GET"
                    }).then(function (category) {
                        createCategoryFormDialog.dialog("open");

                        $("#create-category-form-wrapper .modal-form").append("<input id='Id' name='Id' type='hidden' value='" + category.Id + "'/>")
                        $("#create-category-form-wrapper #Name").attr("value", category.Name);
                        $("#create-category-form-wrapper #CoverUrl").attr("value", category.CoverUrl);
                    });

                } else {
                    createCategoryFormDialog.dialog("open");
                }
            });

            // fetching the products per category
            // TODO [GM]: Implement fully, add server paging
            $(".category-partial > a").on("click", function (e) {
                var categoryId = $(e.currentTarget).attr("shop-role-id");

                $.ajax({
                    url: "/Category/GetCategoryProducts/" + categoryId,
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then(function (res) {
                    var productsHolderElement = $(".products-wrapper > .product-items > section");
                    productsHolderElement.html("");

                    if (Array.from(res).length == 0) {
                        productsHolderElement.html("<p class='p-1 w-100 text-center'>No products found for this category.</p>");
                    }

                    Array.from(res).forEach(function (product) {
                        var template = $("#product-container-template").html();
                        var rendered = Mustache.render(template, product);

                        // fade in animation
                        productsHolderElement.append(rendered).hide().fadeIn("slow");
                    });

                    var orderButtons = $("[shop-action='order-product']");
                    orderButtons.on("click", function () {

                        // show error when not
                        @if (!this.User.Identity.IsAuthenticated)
                        {
                            @: window.location.href = "@Url.Action("Login", "Account")"
                        }
                        else
                        {
                            @:var productQuantity = $(this).parent().parent().find("[shop-product-quantity]");
                            @:var productId = $(this).closest("[shop-product-id]").attr("shop-product-id");
                            @:var productName = $(this).parent().parent().find("[shop-product-name]").attr("shop-product-name");

                            @:confirmOrderDialog.attr("shop-product-id", productId);
                            @:confirmOrderDialog.attr("shop-product-name", productName);
                            @:confirmOrderDialog.attr("shop-product-quantity", productQuantity.val() > 0 ? productQuantity.val() : 0);

                            @:confirmOrderDialog.dialog("open");

                            // emptying the quantity input
                            @:productQuantity.val("");
                        }

                    });

                    var productDetailsButtons = $("[shop-action='product-details']");
                    productDetailsButtons.on("click", function () {
                        var productId = $(this).closest("[shop-product-id]").attr("shop-product-id");
                        // TODO [GM]: Why POST?
                        $.ajax({
                            method: "POST",
                            url: "/Product/GetProduct/" + productId
                        }).then(function (product) {
                            var template = $("#product-details-template").html();
                            var rendered = Mustache.render(template, product);

                            $("#product-details-dialog").html(rendered);

                            productDetailsDialog.dialog("open");
                        });
                    });
                });
            });

            var $form = $(".modal-form");
            $.validator.unobtrusive.parse($form);
        });
    </script>
}